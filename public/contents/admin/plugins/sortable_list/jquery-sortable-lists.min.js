(function (a) {
    a.fn.sortableLists = function (m) {
        var F = a("body").css("position", "relative"),
            u = {
                currElClass: "",
                placeholderClass: "",
                placeholderCss: {
                    position: "relative",
                    padding: 0
                },
                hintClass: "",
                hintCss: {
                    display: "none",
                    position: "relative",
                    padding: 0
                },
                hintWrapperClass: "",
                hintWrapperCss: {},
                baseClass: "",
                baseCss: {
                    position: "absolute",
                    top: 0 - parseInt(F.css("margin-top")),
                    left: 0 - parseInt(F.css("margin-left")),
                    margin: 0,
                    padding: 0,
                    "z-index": 2500
                },
                opener: {
                    active: false,
                    open: "",
                    close: "",
                    openerCss: {
                        "float": "left",
                        display: "inline-block",
                        "background-position": "center center",
                        "background-repeat": "no-repeat"
                    },
                    openerClass: ""
                },
                maxLevels: false,
                listSelector: "ul",
                listsClass: "",
                listsCss: {},
                insertZone: 50,
                insertZonePlus: false,
                scroll: 20,
                ignoreClass: "",
                isAllowed: function (K, M, L) {
                    return true
                },
                onDragStart: function (L, K) {
                    return true
                },
                onChange: function (K) {
                    return true
                },
                complete: function (K) {
                    return true
                }
            },
            D = a.extend(true, {}, u, m),
            p = a("<" + D.listSelector + " />").prependTo(F).attr("id", "s-l-base").css(D.baseCss).addClass(D.listsClass + " " + D.baseClass),
            r = a("<li />").attr("id", "s-l-placeholder").css(D.placeholderCss).addClass(D.placeholderClass),
            x = a("<li />").attr("id", "s-l-hint").css(D.hintCss).addClass(D.hintClass),
            k = a("<" + D.listSelector + " />").attr("id", "s-l-hint-wrapper").addClass(D.listsClass + " " + D.hintWrapperClass).css(D.listsCss).css(D.hintWrapperCss),
            A = a("<span />").addClass("s-l-opener " + D.opener.openerClass).css(D.opener.openerCss).on("mousedown", function (L) {
                var K = a(this).closest("li");
                if (K.hasClass("s-l-closed")) {
                    v(K)
                } else {
                    z(K)
                }
                return false
            });
        if (D.opener.as == "class") {
            A.addClass(D.opener.close)
        } else {
            if (D.opener.as == "html") {
                A.html(D.opener.close)
            } else {
                console.error("jQuerySortableLists opener as background image has been removed with release 2.0.0. Use html instead please.")
            }
        }
        var o = {
            isDragged: false,
            isRelEFP: null,
            oEl: null,
            rootEl: {
                el: a(this),
                offset: null,
                rootElClass: a(this).attr("class")
            },
            cEl: null,
            placeholderParentLi: null,
            upScroll: false,
            downScroll: false,
            pX: 0,
            pY: 0,
            cX: 0,
            cY: 0,
            isAllowed: true,
            e: {
                pageX: 0,
                pageY: 0,
                clientX: 0,
                clientY: 0
            },
            doc: a(document),
            win: a(window)
        };
        if (D.opener.active) {
            if (!D.opener.open) {
                throw "Opener.open value is not defined. It should be valid url, html or css class."
            }
            if (!D.opener.close) {
                throw "Opener.close value is not defined. It should be valid url, html or css class."
            }
            a(this).find("li").each(function () {
                var K = a(this);
                if (K.children(D.listSelector).length) {
                    A.clone(true).prependTo(K.children("div").first());
                    if (!K.hasClass("s-l-open")) {
                        z(K)
                    } else {
                        v(K)
                    }
                }
            })
        }
        if (D.maxLevels !== false) {
            if (isNaN(D.maxLevels)) {
                throw "JQuery-sortable-lists maxLevels values is not a number"
            }
            a(this).find("li").each(function () {
                var L = q(a(this));
                var K = w(a(this));
                c(a(this), L);
                i(a(this), K)
            })
        }
        return this.on("mousedown", function (N) {
            var M = a(N.target);
            if (o.isDragged !== false || (D.ignoreClass && M.hasClass(D.ignoreClass))) {
                return
            }
            N.preventDefault();
            var L = M.closest("li"),
                K = a(this);
            if (L[0]) {
                D.onDragStart(N, L);
                f(N, L, K)
            }
        });

        function f(Q, M, L) {
            o.isDragged = true;
            var S = parseInt(M.css("margin-top")),
                O = parseInt(M.css("margin-bottom")),
                K = parseInt(M.css("margin-left")),
                T = parseInt(M.css("margin-right")),
                R = M.offset(),
                P = M.innerHeight();
            o.rootEl = {
                el: L,
                offset: L.offset(),
                rootElClass: L.attr("class")
            };
            o.cEl = {
                el: M,
                mT: S,
                mL: K,
                mB: O,
                mR: T,
                offset: R
            };
            o.cEl.xyOffsetDiff = {
                X: Q.pageX - o.cEl.offset.left,
                Y: Q.pageY - o.cEl.offset.top
            };
            o.cEl.el.addClass("s-l-current " + D.currElClass);
            M.before(r);
            var N = o.placeholderNode = a("#s-l-placeholder");
            M.css({
                width: M.width(),
                position: "absolute",
                top: R.top - S,
                left: R.left - K
            }).prependTo(p);
            N.css({
                display: "block",
                height: P
            });
            x.css("height", P);
            o.doc.on("mousemove", E).on("mouseup", G)
        }

        function E(N) {
            if (o.isDragged) {
                var K = o.cEl,
                    M = o.doc,
                    L = o.win;
                if (!N.pageX) {
                    g(N)
                }
                if (M.scrollTop() > o.rootEl.offset.top - 10 && N.clientY < 50) {
                    if (!o.upScroll) {
                        B(N)
                    } else {
                        N.pageY = N.pageY - D.scroll;
                        a("html, body").each(function (O) {
                            a(this).scrollTop(a(this).scrollTop() - D.scroll)
                        });
                        j(N)
                    }
                } else {
                    if (M.scrollTop() + L.height() < o.rootEl.offset.top + o.rootEl.el.outerHeight(false) + 10 && L.height() - N.clientY < 50) {
                        if (!o.downScroll) {
                            s(N)
                        } else {
                            N.pageY = N.pageY + D.scroll;
                            a("html, body").each(function (O) {
                                a(this).scrollTop(a(this).scrollTop() + D.scroll)
                            });
                            j(N)
                        }
                    } else {
                        n(o)
                    }
                }
                o.oElOld = o.oEl;
                K.el[0].style.visibility = "hidden";
                o.oEl = oEl = t(N.pageX, N.pageY);
                K.el[0].style.visibility = "visible";
                h(N, o);
                d(N, o)
            }
        }

        function G(O) {
            var N = o.cEl,
                K = a("#s-l-hint", o.rootEl.el),
                Q = x[0].style,
                P = null,
                M = false,
                L = a("#s-l-hint-wrapper");
            if (Q.display == "block" && K.length && o.isAllowed) {
                P = K;
                M = true
            } else {
                P = o.placeholderNode;
                M = false
            }
            offset = P.offset();
            N.el.animate({
                left: offset.left - o.cEl.mL,
                top: offset.top - o.cEl.mT
            }, 250, function () {
                b(N);
                P.after(N.el[0]);
                P[0].style.display = "none";
                Q.display = "none";
                K.remove();
                L.removeAttr("id").removeClass(D.hintWrapperClass);
                if (L.length) {
                    L.prev("div").append(A.clone(true))
                }
                if (M) {
                    o.placeholderNode.slideUp(150, function () {
                        o.placeholderParentLi = (!o.placeholderNode.parent().is(o.rootEl.el)) ? o.placeholderNode.parent().closest("li") : null;
                        o.placeholderNode.remove();
                        H();
                        D.onChange(N.el);
                        D.complete(N.el);
                        o.isDragged = false;
                        if (D.maxLevels !== false) {
                            y(N.el);
                            if (o.placeholderParentLi) {
                                y(o.placeholderParentLi)
                            }
                        }
                    })
                } else {
                    o.placeholderNode.remove();
                    H();
                    D.complete(N.el);
                    o.isDragged = false
                }
            });
            n(o);
            o.doc.unbind("mousemove", E).unbind("mouseup", G)
        }

        function B(K) {
            if (o.upScroll) {
                return
            }
            o.upScroll = setInterval(function () {
                o.doc.trigger("mousemove")
            }, 50)
        }

        function s(K) {
            if (o.downScroll) {
                return
            }
            o.downScroll = setInterval(function () {
                o.doc.trigger("mousemove")
            }, 50)
        }

        function j(K) {
            o.pY = K.pageY;
            o.pX = K.pageX;
            o.cY = K.clientY;
            o.cX = K.clientX
        }

        function g(K) {
            K.pageY = o.pY;
            K.pageX = o.pX;
            K.clientY = o.cY;
            K.clientX = o.cX
        }

        function n(K) {
            clearInterval(K.upScroll);
            clearInterval(K.downScroll);
            K.upScroll = K.downScroll = false
        }

        function d(M, L) {
            var K = L.cEl;
            K.el.css({
                top: M.pageY - K.xyOffsetDiff.Y - K.mT,
                left: M.pageX - K.xyOffsetDiff.X - K.mL
            })
        }

        function t(K, P) {
            if (!document.elementFromPoint) {
                return null
            }
            var O = o.isRelEFP;
            if (O === null) {
                var N, L;
                if ((N = o.doc.scrollTop()) > 0) {
                    O = ((L = document.elementFromPoint(0, N + a(window).height() - 1)) == null || L.tagName.toUpperCase() == "HTML")
                }
                if ((N = o.doc.scrollLeft()) > 0) {
                    O = ((L = document.elementFromPoint(N + a(window).width() - 1, 0)) == null || L.tagName.toUpperCase() == "HTML")
                }
            }
            if (O) {
                K -= o.doc.scrollLeft();
                P -= o.doc.scrollTop()
            }
            var M = a(document.elementFromPoint(K, P));
            if (!o.rootEl.el.find(M).length) {
                return null
            } else {
                if (M.is("#s-l-placeholder") || M.is("#s-l-hint")) {
                    return null
                } else {
                    if (!M.is("li")) {
                        M = M.closest("li");
                        return M[0] ? M : null
                    } else {
                        if (M.is("li")) {
                            return M
                        }
                    }
                }
            }
        }

        function h(O, N) {
            var K = N.oEl;
            if (!K || !N.oElOld) {
                return
            }
            var M = K.outerHeight(false),
                L = O.pageY - K.offset().top;
            if (D.insertZonePlus) {
                if (14 > L) {
                    e(O, K, 7 > L)
                } else {
                    if (M - 14 < L) {
                        C(O, K, M - 7 < L)
                    }
                }
            } else {
                if (5 > L) {
                    l(O, K)
                } else {
                    if (M - 5 < L) {
                        J(O, K)
                    }
                }
            }
        }

        function l(N, K) {
            if (a("#s-l-hint-wrapper", o.rootEl.el).length) {
                x.unwrap()
            }
            if (N.pageX - K.offset().left < D.insertZone) {
                if ((K.prev("#s-l-placeholder").length) || (D.maxLevels !== false && !I(false))) {
                    x.css("display", "none");
                    return
                }
                K.before(x)
            } else {
                var L = K.children(),
                    M = K.children(D.listSelector).first();
                if ((M.children().first().is("#s-l-placeholder")) || (D.maxLevels !== false && !I(true))) {
                    x.css("display", "none");
                    return
                }
                if (!M.length) {
                    L.first().after(x);
                    x.wrap(k)
                } else {
                    M.prepend(x)
                }
                if (o.oEl) {
                    v(K)
                }
            }
            x.css("display", "block");
            o.isAllowed = D.isAllowed(o.cEl.el, x, x.parents("li").first())
        }

        function e(O, K, N) {
            if (a("#s-l-hint-wrapper", o.rootEl.el).length) {
                x.unwrap()
            }
            if (!N && O.pageX - K.offset().left > D.insertZone) {
                var L = K.children(),
                    M = K.children(D.listSelector).first();
                if ((M.children().first().is("#s-l-placeholder")) || (D.maxLevels !== false && !I(true))) {
                    x.css("display", "none");
                    return
                }
                if (!M.length) {
                    L.first().after(x);
                    x.wrap(k)
                } else {
                    M.prepend(x)
                }
                if (o.oEl) {
                    v(K)
                }
            } else {
                if ((K.prev("#s-l-placeholder").length) || (D.maxLevels !== false && !I(false))) {
                    x.css("display", "none");
                    return
                }
                K.before(x)
            }
            x.css("display", "block");
            o.isAllowed = D.isAllowed(o.cEl.el, x, x.parents("li").first())
        }

        function J(N, K) {
            if (a("#s-l-hint-wrapper", o.rootEl.el).length) {
                x.unwrap()
            }
            if (N.pageX - K.offset().left < D.insertZone) {
                if ((K.next("#s-l-placeholder").length) || (D.maxLevels !== false && !I(false))) {
                    x.css("display", "none");
                    return
                }
                K.after(x)
            } else {
                var L = K.children(),
                    M = K.children(D.listSelector).last();
                if ((M.children().last().is("#s-l-placeholder")) || (D.maxLevels !== false && !I(true))) {
                    x.css("display", "none");
                    return
                }
                if (M.length) {
                    L.last().append(x)
                } else {
                    K.append(x);
                    x.wrap(k)
                }
                if (o.oEl) {
                    v(K)
                }
            }
            x.css("display", "block");
            o.isAllowed = D.isAllowed(o.cEl.el, x, x.parents("li").first())
        }

        function C(O, K, N) {
            if (a("#s-l-hint-wrapper", o.rootEl.el).length) {
                x.unwrap()
            }
            if (!N && O.pageX - K.offset().left > D.insertZone) {
                var L = K.children(),
                    M = K.children(D.listSelector).last();
                if ((M.children().last().is("#s-l-placeholder")) || (D.maxLevels !== false && !I(true))) {
                    x.css("display", "none");
                    return
                }
                if (M.length) {
                    L.last().append(x)
                } else {
                    K.append(x);
                    x.wrap(k)
                }
                if (o.oEl) {
                    v(K)
                }
            } else {
                if ((K.next("#s-l-placeholder").length) || (D.maxLevels !== false && !I(false))) {
                    x.css("display", "none");
                    return
                }
                K.after(x)
            }
            x.css("display", "block");
            o.isAllowed = D.isAllowed(o.cEl.el, x, x.parents("li").first())
        }

        function v(K) {
            K.removeClass("s-l-closed").addClass("s-l-open");
            K.children(D.listSelector).css("display", "block");
            var L = K.children("div").children(".s-l-opener").first();
            if (D.opener.as == "html") {
                L.html(D.opener.close)
            } else {
                if (D.opener.as == "class") {
                    L.addClass(D.opener.close).removeClass(D.opener.open)
                }
            }
        }

        function z(K) {
            K.removeClass("s-l-open").addClass("s-l-closed");
            K.children(D.listSelector).css("display", "none");
            var L = K.children("div").children(".s-l-opener").first();
            if (D.opener.as == "html") {
                L.html(D.opener.open)
            } else {
                if (D.opener.as == "class") {
                    L.addClass(D.opener.open).removeClass(D.opener.close)
                }
            }
        }

        function q(K) {
            var O = 0;
            var M = K.children(D.listSelector);
            if (M.length) {
                O++;
                var N = 0;
                var L = 0;
                M.find("li").each(function (P) {
                    L = q(a(this));
                    if (N < L) {
                        N = L
                    }
                });
                if (N) {
                    O = O + N
                }
            }
            return O
        }

        function c(K, L) {
            K.data("insideLevels", L)
        }

        function w(K) {
            var N = 0;
            var M = o.rootEl.el;
            var L = K.closest(D.listSelector);
            while (!L.is(M)) {
                N++;
                L = L.parent().closest(D.listSelector)
            }
            return N
        }

        function i(K, L) {
            K.data("upperLevels", L)
        }

        function I(K) {
            var M = o.cEl.el.data("insideLevels");
            var L = o.oEl.data("upperLevels");
            return D.maxLevels > L + M + (K ? 1 : 0)
        }

        function y(K) {
            var N = o.rootEl.el;
            var L = K.parent(D.listSelector);
            c(K, q(K));
            i(K, w(K));
            var M = 0;
            K.find("li").each(function () {
                var O = a(this);
                c(O, q(O));
                i(O, w(O))
            });
            while (!L.is(N) && M < 50) {
                var K = L.parent("li");
                c(K, q(K));
                L = K.parent(D.listSelector);
                M++
            }
        }

        function b(K) {
            var L = K.el[0].style;
            K.el.removeClass(D.currElClass + " s-l-current");
            L.top = "0";
            L.left = "0";
            L.position = "relative";
            L.width = "auto"
        }

        function H() {
            a(D.listSelector, o.rootEl.el).each(function (K) {
                if (!a(this).children().length) {
                    a(this).prev("div").children(".s-l-opener").first().remove();
                    a(this).remove()
                }
            })
        }
    };
    a.fn.sortableListsToArray = function (c, d) {
        c = c || [];
        var b = 0;
        this.children("li").each(function () {
            var e = a(this),
                f = {},
                g = e.attr("id");
            if (!g) {
                console.log(e);
                throw "Previous item in console.log has no id. It is necessary to create the array."
            }
            f.id = g;
            f.parentId = d;
            f.value = e.data("value");
            f.order = b;
            f.module = e;
            c.push(f);
            e.children("ul,ol").sortableListsToArray(c, g);
            b++
        });
        return c
    };
    a.fn.sortableListsToHierarchy = function () {
        var c = [],
            b = 0;
        a(this).children("li").each(function () {
            var d = a(this),
                e = {},
                f = d.attr("id");
            if (!f) {
                console.log(d);
                throw "Previous item in console.log has no id. It is necessary to create the array."
            }
            e.id = f;
            e.value = d.data("value");
            e.order = b;
            c.push(e);
            e.children = d.children("ul,ol").sortableListsToHierarchy();
            b++
        });
        return c
    };
    a.fn.sortableListsToString = function (b, c) {
        b = b || [];
        c = c || "no-parent";
        a(this).children("li").each(function () {
            var d = a(this),
                f = d.attr("id"),
                e = f ? f.match(/(.+)[-=_](.+)/) : null;
            if (!e) {
                console.log(d);
                throw "Previous item in console.log has no id or id is not in required format xx_yy, xx-yy or xx=yy. It is necessary to create valid string."
            }
            b.push(e[1] + "[" + e[2] + "]=" + c);
            a(this).children("ul,ol").sortableListsToString(b, e[2])
        });
        return b.join("&")
    }
}(jQuery));
