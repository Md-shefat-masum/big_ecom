(function (a) {
    a.fn.sortableLists = function (u) {
        var G = a("body").css("position", "relative"),
            C = {
                currElClass: "",
                placeholderClass: "",
                placeholderCss: {
                    position: "relative",
                    padding: 0
                },
                hintClass: "",
                hintCss: {
                    display: "none",
                    position: "relative",
                    padding: 0
                },
                hintWrapperClass: "",
                hintWrapperCss: {},
                baseClass: "",
                baseCss: {
                    position: "absolute",
                    top: 0 - parseInt(G.css("margin-top")),
                    left: 0 - parseInt(G.css("margin-left")),
                    margin: 0,
                    padding: 0,
                    "z-index": 2500
                },
                opener: {
                    active: false,
                    open: "",
                    close: "",
                    openerCss: {
                        "float": "left",
                        display: "inline-block",
                        "background-position": "center center",
                        "background-repeat": "no-repeat"
                    },
                    openerClass: ""
                },
                maxLevels: false,
                listSelector: "ul",
                listsClass: "",
                listsCss: {},
                insertZone: 50,
                insertZonePlus: false,
                scroll: 20,
                ignoreClass: "",
                isAllowed: function (L, N, M) {
                    return true
                },
                onDragStart: function (M, L) {
                    return true
                },
                onChange: function (L) {
                    return true
                },
                complete: function (L) {
                    return true
                }
            },
            e = a.extend(true, {}, C, u),
            q = a("<" + e.listSelector + " />").prependTo(G).attr("id", "s-l-base").css(e.baseCss).addClass(e.listsClass + " " + e.baseClass),
            z = a("<li />").attr("id", "s-l-placeholder").css(e.placeholderCss).addClass(e.placeholderClass),
            r = a("<li />").attr("id", "s-l-hint").css(e.hintCss).addClass(e.hintClass),
            v = a("<" + e.listSelector + " />").attr("id", "s-l-hint-wrapper").addClass(e.listsClass + " " + e.hintWrapperClass).css(e.listsCss).css(e.hintWrapperCss),
            f = a("<span />").addClass("s-l-opener " + e.opener.openerClass).css(e.opener.openerCss).on("mousedown touchstart", function (M) {
                var L = a(this).closest("li");
                if (L.hasClass("s-l-closed")) {
                    t(L)
                } else {
                    F(L)
                }
                return false
            });
        if (e.opener.as == "class") {
            f.addClass(e.opener.close)
        } else {
            if (e.opener.as == "html") {
                f.html(e.opener.close)
            } else {
                console.error("jQuerySortableLists opener as background image has been removed with release 2.0.0. Use html instead please.")
            }
        }
        var K = {
            isDragged: false,
            isRelEFP: null,
            oEl: null,
            rootEl: {
                el: a(this),
                offset: null,
                rootElClass: a(this).attr("class")
            },
            cEl: null,
            placeholderParentLi: null,
            upScroll: false,
            downScroll: false,
            pX: 0,
            pY: 0,
            cX: 0,
            cY: 0,
            isAllowed: true,
            e: {
                pageX: 0,
                pageY: 0,
                clientX: 0,
                clientY: 0
            },
            doc: a(document),
            win: a(window)
        };
        if (e.opener.active) {
            if (!e.opener.open) {
                throw "Opener.open value is not defined. It should be valid url, html or css class."
            }
            if (!e.opener.close) {
                throw "Opener.close value is not defined. It should be valid url, html or css class."
            }
            a(this).find("li").each(function () {
                var L = a(this);
                if (L.children(e.listSelector).length) {
                    f.clone(true).prependTo(L.children("div").first());
                    if (!L.hasClass("s-l-open")) {
                        F(L)
                    } else {
                        t(L)
                    }
                }
            })
        }
        if (e.maxLevels !== false) {
            if (isNaN(e.maxLevels)) {
                throw "JQuery-sortable-lists maxLevels values is not a number"
            }
            a(this).find("li").each(function () {
                var M = J(a(this));
                var L = A(a(this));
                m(a(this), M);
                o(a(this), L)
            })
        }
        return this.on("mousedown touchstart", function (O) {
            var N = a(O.target);
            if (K.isDragged !== false || (e.ignoreClass && N.hasClass(e.ignoreClass))) {
                return
            }
            O.preventDefault();
            if (O.type === "touchstart") {
                j(O)
            }
            var M = N.closest("li"),
                L = a(this);
            if (M[0]) {
                e.onDragStart(O, M);
                p(O, M, L)
            }
        });

        function p(R, N, M) {
            K.isDragged = true;
            var T = parseInt(N.css("margin-top")),
                P = parseInt(N.css("margin-bottom")),
                L = parseInt(N.css("margin-left")),
                U = parseInt(N.css("margin-right")),
                S = N.offset(),
                Q = N.innerHeight();
            K.rootEl = {
                el: M,
                offset: M.offset(),
                rootElClass: M.attr("class")
            };
            K.cEl = {
                el: N,
                mT: T,
                mL: L,
                mB: P,
                mR: U,
                offset: S
            };
            K.cEl.xyOffsetDiff = {
                X: R.pageX - K.cEl.offset.left,
                Y: R.pageY - K.cEl.offset.top
            };
            K.cEl.el.addClass("s-l-current " + e.currElClass);
            N.before(z);
            var O = K.placeholderNode = a("#s-l-placeholder");
            N.css({
                width: N.width(),
                position: "absolute",
                top: S.top - T,
                left: S.left - L
            }).prependTo(q);
            O.css({
                display: "block",
                height: Q
            });
            r.css("height", Q);
            K.doc.on("mousemove touchmove", d).on("mouseup touchend touchcancel", B)
        }

        function d(O) {
            if (K.isDragged) {
                var L = K.cEl,
                    N = K.doc,
                    M = K.win;
                if (O.type === "touchmove") {
                    j(O)
                }
                if (!O.pageX) {
                    n(O)
                }
                if (N.scrollTop() > K.rootEl.offset.top - 10 && O.clientY < 50) {
                    if (!K.upScroll) {
                        E(O)
                    } else {
                        O.pageY = O.pageY - e.scroll;
                        a("html, body").each(function (P) {
                            a(this).scrollTop(a(this).scrollTop() - e.scroll)
                        });
                        i(O)
                    }
                } else {
                    if (N.scrollTop() + M.height() < K.rootEl.offset.top + K.rootEl.el.outerHeight(false) + 10 && M.height() - O.clientY < 50) {
                        if (!K.downScroll) {
                            y(O)
                        } else {
                            O.pageY = O.pageY + e.scroll;
                            a("html, body").each(function (P) {
                                a(this).scrollTop(a(this).scrollTop() + e.scroll)
                            });
                            i(O)
                        }
                    } else {
                        D(K)
                    }
                }
                K.oElOld = K.oEl;
                L.el[0].style.visibility = "hidden";
                K.oEl = oEl = g(O.pageX, O.pageY);
                L.el[0].style.visibility = "visible";
                l(O, K);
                w(O, K)
            }
        }

        function B(P) {
            var O = K.cEl,
                L = a("#s-l-hint", K.rootEl.el),
                R = r[0].style,
                Q = null,
                N = false,
                M = a("#s-l-hint-wrapper");
            if (P.type === "touchend" || P.type === "touchcancel") {
                j(P)
            }
            if (R.display == "block" && L.length && K.isAllowed) {
                Q = L;
                N = true
            } else {
                Q = K.placeholderNode;
                N = false
            }
            offset = Q.offset();
            O.el.animate({
                left: offset.left - K.cEl.mL,
                top: offset.top - K.cEl.mT
            }, 250, function () {
                s(O);
                Q.after(O.el[0]);
                Q[0].style.display = "none";
                R.display = "none";
                L.remove();
                M.removeAttr("id").removeClass(e.hintWrapperClass);
                if (M.length) {
                    M.prev("div").append(f.clone(true))
                }
                if (N) {
                    K.placeholderNode.slideUp(150, function () {
                        K.placeholderParentLi = (!K.placeholderNode.parent().is(K.rootEl.el)) ? K.placeholderNode.parent().closest("li") : null;
                        K.placeholderNode.remove();
                        c();
                        e.onChange(O.el);
                        e.complete(O.el);
                        K.isDragged = false;
                        if (e.maxLevels !== false) {
                            h(O.el);
                            if (K.placeholderParentLi) {
                                h(K.placeholderParentLi)
                            }
                        }
                    })
                } else {
                    K.placeholderNode.remove();
                    c();
                    e.complete(O.el);
                    K.isDragged = false
                }
            });
            D(K);
            K.doc.unbind("mousemove touchmove", d).unbind("mouseup touchend touchcancel", B)
        }

        function E(L) {
            if (K.upScroll) {
                return
            }
            K.upScroll = setInterval(function () {
                K.doc.trigger("mousemove")
            }, 50)
        }

        function y(L) {
            if (K.downScroll) {
                return
            }
            K.downScroll = setInterval(function () {
                K.doc.trigger("mousemove")
            }, 50)
        }

        function i(L) {
            K.pY = L.pageY;
            K.pX = L.pageX;
            K.cY = L.clientY;
            K.cX = L.clientX
        }

        function n(L) {
            L.pageY = K.pY;
            L.pageX = K.pX;
            L.clientY = K.cY;
            L.clientX = K.cX
        }

        function D(L) {
            clearInterval(L.upScroll);
            clearInterval(L.downScroll);
            L.upScroll = L.downScroll = false
        }

        function j(L) {
            L.pageX = L.originalEvent.changedTouches[0].pageX;
            L.pageY = L.originalEvent.changedTouches[0].pageY;
            L.screenX = L.originalEvent.changedTouches[0].screenX;
            L.screenY = L.originalEvent.changedTouches[0].screenY
        }

        function w(N, M) {
            var L = M.cEl;
            L.el.css({
                top: N.pageY - L.xyOffsetDiff.Y - L.mT,
                left: N.pageX - L.xyOffsetDiff.X - L.mL
            })
        }

        function g(L, Q) {
            if (!document.elementFromPoint) {
                return null
            }
            var P = K.isRelEFP;
            if (P === null) {
                var O, M;
                if ((O = K.doc.scrollTop()) > 0) {
                    P = ((M = document.elementFromPoint(0, O + a(window).height() - 1)) == null || M.tagName.toUpperCase() == "HTML")
                }
                if ((O = K.doc.scrollLeft()) > 0) {
                    P = ((M = document.elementFromPoint(O + a(window).width() - 1, 0)) == null || M.tagName.toUpperCase() == "HTML")
                }
            }
            if (P) {
                L -= K.doc.scrollLeft();
                Q -= K.doc.scrollTop()
            }
            var N = a(document.elementFromPoint(L, Q));
            if (!K.rootEl.el.find(N).length) {
                return null
            } else {
                if (N.is("#s-l-placeholder") || N.is("#s-l-hint")) {
                    return null
                } else {
                    if (!N.is("li")) {
                        N = N.closest("li");
                        return N[0] ? N : null
                    } else {
                        if (N.is("li")) {
                            return N
                        }
                    }
                }
            }
        }

        function l(P, O) {
            var L = O.oEl;
            if (!L || !O.oElOld) {
                return
            }
            var N = L.outerHeight(false),
                M = P.pageY - L.offset().top;
            if (e.insertZonePlus) {
                if (14 > M) {
                    I(P, L, 7 > M)
                } else {
                    if (N - 14 < M) {
                        H(P, L, N - 7 < M)
                    }
                }
            } else {
                if (5 > M) {
                    k(P, L)
                } else {
                    if (N - 5 < M) {
                        b(P, L)
                    }
                }
            }
        }

        function k(O, L) {
            if (a("#s-l-hint-wrapper", K.rootEl.el).length) {
                r.unwrap()
            }
            if (O.pageX - L.offset().left < e.insertZone) {
                if ((L.prev("#s-l-placeholder").length) || (e.maxLevels !== false && !x(false))) {
                    r.css("display", "none");
                    return
                }
                L.before(r)
            } else {
                var M = L.children(),
                    N = L.children(e.listSelector).first();
                if ((N.children().first().is("#s-l-placeholder")) || (e.maxLevels !== false && !x(true))) {
                    r.css("display", "none");
                    return
                }
                if (!N.length) {
                    M.first().after(r);
                    r.wrap(v)
                } else {
                    N.prepend(r)
                }
                if (K.oEl) {
                    t(L)
                }
            }
            r.css("display", "block");
            K.isAllowed = e.isAllowed(K.cEl.el, r, r.parents("li").first())
        }

        function I(P, L, O) {
            if (a("#s-l-hint-wrapper", K.rootEl.el).length) {
                r.unwrap()
            }
            if (!O && P.pageX - L.offset().left > e.insertZone) {
                var M = L.children(),
                    N = L.children(e.listSelector).first();
                if ((N.children().first().is("#s-l-placeholder")) || (e.maxLevels !== false && !x(true))) {
                    r.css("display", "none");
                    return
                }
                if (!N.length) {
                    M.first().after(r);
                    r.wrap(v)
                } else {
                    N.prepend(r)
                }
                if (K.oEl) {
                    t(L)
                }
            } else {
                if ((L.prev("#s-l-placeholder").length) || (e.maxLevels !== false && !x(false))) {
                    r.css("display", "none");
                    return
                }
                L.before(r)
            }
            r.css("display", "block");
            K.isAllowed = e.isAllowed(K.cEl.el, r, r.parents("li").first())
        }

        function b(O, L) {
            if (a("#s-l-hint-wrapper", K.rootEl.el).length) {
                r.unwrap()
            }
            if (O.pageX - L.offset().left < e.insertZone) {
                if ((L.next("#s-l-placeholder").length) || (e.maxLevels !== false && !x(false))) {
                    r.css("display", "none");
                    return
                }
                L.after(r)
            } else {
                var M = L.children(),
                    N = L.children(e.listSelector).last();
                if ((N.children().last().is("#s-l-placeholder")) || (e.maxLevels !== false && !x(true))) {
                    r.css("display", "none");
                    return
                }
                if (N.length) {
                    M.last().append(r)
                } else {
                    L.append(r);
                    r.wrap(v)
                }
                if (K.oEl) {
                    t(L)
                }
            }
            r.css("display", "block");
            K.isAllowed = e.isAllowed(K.cEl.el, r, r.parents("li").first())
        }

        function H(P, L, O) {
            if (a("#s-l-hint-wrapper", K.rootEl.el).length) {
                r.unwrap()
            }
            if (!O && P.pageX - L.offset().left > e.insertZone) {
                var M = L.children(),
                    N = L.children(e.listSelector).last();
                if ((N.children().last().is("#s-l-placeholder")) || (e.maxLevels !== false && !x(true))) {
                    r.css("display", "none");
                    return
                }
                if (N.length) {
                    M.last().append(r)
                } else {
                    L.append(r);
                    r.wrap(v)
                }
                if (K.oEl) {
                    t(L)
                }
            } else {
                if ((L.next("#s-l-placeholder").length) || (e.maxLevels !== false && !x(false))) {
                    r.css("display", "none");
                    return
                }
                L.after(r)
            }
            r.css("display", "block");
            K.isAllowed = e.isAllowed(K.cEl.el, r, r.parents("li").first())
        }

        function t(L) {
            L.removeClass("s-l-closed").addClass("s-l-open");
            L.children(e.listSelector).css("display", "block");
            var M = L.children("div").children(".s-l-opener").first();
            if (e.opener.as == "html") {
                M.html(e.opener.close)
            } else {
                if (e.opener.as == "class") {
                    M.addClass(e.opener.close).removeClass(e.opener.open)
                }
            }
        }

        function F(L) {
            L.removeClass("s-l-open").addClass("s-l-closed");
            L.children(e.listSelector).css("display", "none");
            var M = L.children("div").children(".s-l-opener").first();
            if (e.opener.as == "html") {
                M.html(e.opener.open)
            } else {
                if (e.opener.as == "class") {
                    M.addClass(e.opener.open).removeClass(e.opener.close)
                }
            }
        }

        function J(L) {
            var P = 0;
            var N = L.children(e.listSelector);
            if (N.length) {
                P++;
                var O = 0;
                var M = 0;
                N.find("li").each(function (Q) {
                    M = J(a(this));
                    if (O < M) {
                        O = M
                    }
                });
                if (O) {
                    P = P + O
                }
            }
            return P
        }

        function m(L, M) {
            L.data("insideLevels", M)
        }

        function A(L) {
            var O = 0;
            var N = K.rootEl.el;
            var M = L.closest(e.listSelector);
            while (!M.is(N)) {
                O++;
                M = M.parent().closest(e.listSelector)
            }
            return O
        }

        function o(L, M) {
            L.data("upperLevels", M)
        }

        function x(L) {
            var N = K.cEl.el.data("insideLevels");
            var M = K.oEl.data("upperLevels");
            return e.maxLevels > M + N + (L ? 1 : 0)
        }

        function h(L) {
            var O = K.rootEl.el;
            var M = L.parent(e.listSelector);
            m(L, J(L));
            o(L, A(L));
            var N = 0;
            L.find("li").each(function () {
                var P = a(this);
                m(P, J(P));
                o(P, A(P))
            });
            while (!M.is(O) && N < 50) {
                var L = M.parent("li");
                m(L, J(L));
                M = L.parent(e.listSelector);
                N++
            }
        }

        function s(L) {
            var M = L.el[0].style;
            L.el.removeClass(e.currElClass + " s-l-current");
            M.top = "0";
            M.left = "0";
            M.position = "relative";
            M.width = "auto"
        }

        function c() {
            a(e.listSelector, K.rootEl.el).each(function (L) {
                if (!a(this).children().length) {
                    a(this).prev("div").children(".s-l-opener").first().remove();
                    a(this).remove()
                }
            })
        }
    };
    a.fn.sortableListsToArray = function (c, d) {
        c = c || [];
        var b = 0;
        this.children("li").each(function () {
            var e = a(this),
                f = {},
                g = e.attr("id");
            if (!g) {
                console.log(e);
                throw "Previous item in console.log has no id. It is necessary to create the array."
            }
            f.id = g;
            f.parentId = d;
            f.value = e.data("value");
            f.order = b;
            f.dataset = e[0].dataset;
            c.push(f);
            e.children("ul,ol").sortableListsToArray(c, g);
            b++
        });
        return c
    };
    a.fn.sortableListsToHierarchy = function () {
        var c = [],
            b = 0;
        a(this).children("li").each(function () {
            var d = a(this),
                e = {},
                f = d.attr("id");
            if (!f) {
                console.log(d);
                throw "Previous item in console.log has no id. It is necessary to create the array."
            }
            e.id = f;
            e.value = d.data("value");
            e.order = b;
            c.push(e);
            e.children = d.children("ul,ol").sortableListsToHierarchy();
            b++
        });
        return c
    };
    a.fn.sortableListsToString = function (b, c) {
        b = b || [];
        c = c || "no-parent";
        a(this).children("li").each(function () {
            var d = a(this),
                f = d.attr("id"),
                e = f ? f.match(/(.+)[-=_](.+)/) : null;
            if (!e) {
                console.log(d);
                throw "Previous item in console.log has no id or id is not in required format xx_yy, xx-yy or xx=yy. It is necessary to create valid string."
            }
            b.push(e[1] + "[" + e[2] + "]=" + c);
            a(this).children("ul,ol").sortableListsToString(b, e[2])
        });
        return b.join("&")
    }
}(jQuery));
